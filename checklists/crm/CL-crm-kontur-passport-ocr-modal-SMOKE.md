# Чек-лист — CRM → Проверки → Контур (CV) → Распознавание паспорта (модалка) — SMOKE

**Project:** CRM  
**Компонент/Модуль:** Контур (CV)  
**Раздел:** Проверки  
**Подраздел:** Распознавание паспорта (модалка)  
**Экран/URL/Маршрут:** https://crm-test.anflat.ru/tools/kontur-check#props[id]=0&props[type]=person&component=check-kontur-show&label=Проверка&viewType=panel  
**Тестер:** Юлия  
**Дата:** 30.10.2025  
**Окружение:** **test**  
**Сборка/Версия:** **v.689ce285**  
**Роль:** **admin**  
**ОС/Браузер/Разрешение:** **Windows 11 / Chrome (последняя) / 1920×1080**

### Предусловия
- [x] Пользователь авторизован (admin), открыт экран «Проверки контур».  
- [x] Доступны тестовые файлы паспортов РФ (первая страница).

### Тестовые данные (набор минимум)
- [x] Скан ровный, читабельный (jpg).  
- [x] Фото с телефона под углом (jpg).  
- [x] PDF c 1 страницей.  
- [x] Низкое качество/шум.  
- [x] Паспорт без отчества.  
- [x] Другая страна/неверный документ (негатив).

---

## 1) Триггер и загрузка
- [x] Кнопка **«Проверить физ. лицо»** доступна и открывает диалог загрузки.  
- [x] При выборе файла запускается распознавание, показывается индикатор/статус.  
- [ ] Поддерживаемые форматы: jpg, jpeg, png, pdf; неверные — с дружелюбной ошибкой.

## 2) UI модалки (2 колонки)
- [x] Слева — поля результата (редактируемые); справа — превью с подсветкой областей.  
- [x] Актуальная кнопка **«Применить»** (активируется при наличии валидных данных).  
- [x] **«Отмена»** закрывает без изменений.  
- [x] Переключение фокуса на поле подсвечивает соответствующую область на картинке; клик по области — фокусирует поле.

## 3) Сопоставление полей (mapping из ответа бэка)
Проверить автозаполнение и корректность нормализации/регистров.
- [x] `surname` → **Фамилия**  
- [x] `name` → **Имя**  
- [x] `middle_name` → **Отчество** (пусто допускается)  
- [x] `gender` («муж/жен») → **Пол** (селект «Мужской/Женский»)  
- [x] `birth_date` (ДД.ММ.ГГГГ) → **Дата рождения**  
- [x] `birth_place` → **Место рождения** (нормализация «гор.» → «г.»/Title Case)  
- [x] `number` (10 цифр) → разбиение на **Серия** (первые 4) и **Номер** (последние 6)  
- [ ] `subdivision` → **Код подразделения** (формат `000-000`)  
- [ ] `issue_date` → **Дата выдачи** (ДД.ММ.ГГГГ)  
- [ ] `issued_by` → **Кем выдан** (обрезка лишних пробелов, регистр)  
- [ ] `citizenship` → **Гражданство** (rus → «Россия»)  
- [ ] `expiration_date` отсутствует/«-» → поле не заполняем (или скрыто)

## 4) Валидации и бизнес-правила
- [x] Даты в формате ДД.ММ.ГГГГ; без будущих дат.  
- [x] Серия = 4 цифры, Номер = 6 цифр.  
- [ ] Код подразделения соответствует шаблону `NNN-NNN`.  
- [x] Поле «Отчество» необязательное; пустое не блокирует «Применить».  
- [ ] Нельзя применить при критических ошибках (нет серии/номера/ФИО/даты рождения).

## 5) Работа с картинкой и областями
- [x] Показаны рамки (bounding boxes) из `position.min/max`; совпадают с реальными зонами.  
- [x] Зум/перемещение изображения без артефактов.  
- [ ] При ручной правке поля подсветка не мешает вводу.

## 6) Кнопки и результат
- [x] **Применить** закрывает модалку и переносит данные в форму «Физ. лицо» на экране контура.  
- [x] Ручные правки сохраняются и переносятся (не перетираются старым распознаванием).  
- [x] **Отмена** не изменяет форму; повторное открытие — распознаёт заново (или показывает последний результат — по ТЗ, отметить фактическое).

## 7) Ошибки/устойчивость (негативы)
- [ ] Не тот документ (иностранный/загран) — понятная ошибка/предложение заменить файл.  
- [ ] Сильно размыто/пересвечено — сообщение с рекомендациями; отсутствие крашей.

## 8) Производительность и метрики
- [x] Время распознавания ≤ 3 с на файл среднего качества.  
- [x] Нет ошибок в консоли, сеть 200/4xx-контролируемо.  
- [ ] Метрика `cv.detect.send.dialog` шлётся 1 раз на вызов, с полями: статус (success/fail), длительность, тип файла, размер.

## 9) Безопасность/PII
- [x] Очистка временных данных после закрытия модалки (по ТЗ; отметить фактическое).

---

## Результат проверки / Комментарии / Файлы
- Итог: **Fail**  
- Комментарии: см. «Итоги проверки».  
- Файлы: `checklists/crm/assets/Снимок экрана 2025-10-30 110013.png`, `checklists/crm/assets/Снимок экрана 2025-10-30 111953.png`

## Итоги проверки (комментарий к чек-листу)

**Сессия:** CRM → Проверки / Распознавание паспорта (модалка) (SMOKE)  
**Дата:** 30.10.2025  
**Сборка/Версия:** **v.689ce285**  
**URL:** «Проверить физ. лицо» (диалог на экране Контур)

### Покрытие
- Загрузка файлов (jpg/png/webp/pdf), запуск распознавания  
- Маппинг полей: серия/номер, код подразделения, ФИО, даты  
- Валидации обязательных полей, активность «Применить»  
- Базовые метрики (эвент `cv.detect.send.dialog`) — требуется проверка в логах

### Найдено
- **WEBP → 503:** загрузка `.webp` приводит к 5xx, модалка «падает».  
- **PDF:** не даёт загрузить вовсе (ожидалась поддержка, как в «Документах клиента»).  
- **Маппинг:** неверные интерпретации отдельных полей; **код подразделения** не распознан.  
- **Валидация:** «Применить» активна при **пустой Серии**.

### Вывод
- **Status:** **Fail**  
- Риски: потеря данных/краши при неподдерживаемых форматах; ошибочные записи.

### План ретеста (после фиксов)
1. Форматы: jpg/png/webp/pdf — 1 попытка = 1 эвент, без 5xx, корректные ошибки для неподдерживаемых.  
2. Маппинг: корректное заполнение и нормализация (Title Case, маски), код подразделения `NNN-NNN`.  
3. Валидации: «Применить» активна только при валидных обязательных полях.

### Ретест-лог
| Баг/Задача | Что фиксили | Версия | Результат | Примечания |
| --- | --- | --- | --- | --- |
| CRM-4312 | Формат webp: обработка/валидация | v.<hash> | ☐ / ✅ |  |
| CRM-4312 | Поддержка/валидация PDF | v.<hash> | ☐ / ✅ |  |
| CRM-4312 | Маппинг полей + код подразделения | v.<hash> | ☐ / ✅ |  |
| CRM-4312 | Валидации формы / «Применить» | v.<hash> | ☐ / ✅ |  |

### Примечания / Артефакты
- Скрины: `checklists/crm/assets/Снимок экрана 2025-10-30 110013.png`, `checklists/crm/assets/Снимок экрана 2025-10-30 111953.png`
